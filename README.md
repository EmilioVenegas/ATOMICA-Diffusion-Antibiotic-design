# ATOMICA-Diffusion-Antibiotic-design

## ðŸš€ Project Goal

The primary goal of this repository is to demonstrate how to *condition the generative capabilities of DiffSBDD on the rich, learned interaction embeddings from ATOMICA*. This allows the diffusion model to generate molecules with a deeper understanding of the specific protein pocket's chemical and geometric environment, as encoded by ATOMICA.

ATOMICA-Diffusion-RL is a unified pipeline for *de novo* antibiotic design. It conditions an SE(3)-equivariant diffusion model (DiffSBDD) using ATOMICAâ€™s universal interaction interface embeddings. The goal is optimizing leads for properties like ADMET against pathogens, such as multidrug-resistant *Acinetobacter baumannii*.

This repository integrates the [**ATOMICA**](https://www.google.com/search?q=ATOMICA/README.md) embedding model with the [**DiffSBDD**](https://www.google.com/search?q=DiffSBDD/README.md) generative model. This document highlights the primary modifications and new components created for this integration.

## Core Integration & Modifications

The core of this project involved modifying DiffSBDD to accept and be conditioned by the pocket embeddings generated by ATOMICA. This was achieved through new data processing pipelines, new model architectures, and updated configurations.

### 1. Data Preprocessing Pipeline

A new script, **`process_atomica_jsonl.py`**, was created to act as the bridge between the ATOMICA data format and the DiffSBDD training input.

* **Purpose:** To parse complex data from a `.jsonl.gz` file.
<img width="1963" height="1184" alt="Untitled diagram-2025-10-30-211120" src="https://github.com/user-attachments/assets/8f1b7a13-567e-49b4-96e2-72ca813282b9" />

* **Function:**

  1. It loads a pre-trained ATOMICA model.

  2. For each protein-ligand complex, it separates the pocket and ligand atoms.

  3. It feeds the pocket atoms into the ATOMICA model to generate `pocket_atomica_embeddings`.

  4. It saves the ligand coordinates, ligand one-hot encodings, pocket coordinates, and the new `pocket_atomica_embeddings` into individual `.pt` files.
<img width="4166" height="388" alt="Untitled diagram-2025-10-30-211619" src="https://github.com/user-attachments/assets/eaecb4e8-e619-43cb-98f3-5ac7cf04a823" />



### 2. SE(3) Cross-Attention Architecture

To allow the diffusion model to be conditioned on the new embeddings, a new network architecture was introduced in **`DiffSBDD/equivariant_diffusion/egnn_new.py`**. This file adds several new modules to perform SE(3) equivariant cross-attention.

This allows the model to integrate information from the static pocket embeddings (which act as **Key/Value** pairs) into the diffusion process of the ligand atoms (which act as **Queries**).

* **`CrossGCL`**: A modified Graph Convolutional Layer (GCL) for cross-attention. It computes messages from Key/Value (KV) nodes to Query (Q) nodes and only updates the Q nodes.

* **`CrossEquivariantBlock`**: This block wraps the `CrossGCL` and an `EquivariantUpdate` module. It handles the equivariant update of the Query nodes' features (`h_q`) and coordinates (`x_q`) based on the features and coordinates of the Key/Value nodes (`h_kv`, `x_kv`).

* **`SE3CrossAttention`**: The main module that wraps the `CrossEquivariantBlock` layers. It handles the initial feature embeddings for both the Q (ligand) and KV (pocket) inputs and passes them through the attention blocks to produce the final, conditioned ligand atom features and coordinates.

### 3. Dataset & Configuration

The DiffSBDD data-loading pipeline and configuration were updated to support the new ATOMICA-based dataset.

* **`DiffSBDD/constants.py`:**

  * This file was updated with ATOMICA's specific vocabulary, including `atomica_atom_decoder`, `atomica_atom_encoder`, and `atomica_block_vocab`.

  * A new dataset profile, `atomica_PL`, was added to `dataset_params` to use these new vocabularies.

* **`DiffSBDD/dataset.py`:**

  * The `ProcessedLigandPocketDataset` class was modified to load data from a directory of `.pt` files (the output of `process_atomica_jsonl.py`) instead of a single `.npz` file.

  * The data loader was updated to correctly load and collate the `pocket_atomica_embeddings` for batching.

* **`DiffSBDD/configs/`:**

  * New configuration files, such as `atomica_train.yml`, were added.

  * These configs define the new run parameters, setting the `pocket_representation: atomica` and `dataset: atomica_PL`.

  * They also specify the `atomica_embed_dim` in the `egnn_params` section, confirming the use of embeddings as a model parameter.

### 4. Utility Functions

* **`DiffSBDD/utils.py`:** This file was updated with helper functions (`format_atomica_batch`, `load_atomica_model`) to load the ATOMICA model and format data for it, supporting the preprocessing script.

## [ATOMICA](https://www.google.com/search?q=ATOMICA/README.md): Learning Universal Representations of Intermolecular Interactions

ATOMICA is a geometric AI model that learns universal representations of molecular interactions at an atomic scale. The model is pretrained on 2,037,972 molecular interaction interfaces. Embeddings from ATOMICA are used in this repository as the conditioning signal for the generative model.

**For full installation, training, and usage details, please see the [ATOMICA README](https://www.google.com/search?q=ATOMICA/README.md).**

### :scroll: Citation
```
@article{fang2025atomica,
  title={Learning Universal Representations of Intermolecular Interactions with ATOMICA},
  author={Fang, Ada and DesgagnÃ©, Michael and Zhang, Zaixi and Zhou, Andrew and Loscalzo, Joseph, and Pentelute, Bradley L and Zitnik, Marinka},
  journal={In Review},
  url={[https://www.biorxiv.org/content/10.1011/2025.04.02.646906](https://www.biorxiv.org/content/10.1011/2025.04.02.646906)},
  year={2025}
}
```


## [DiffSBDD](https://www.google.com/search?q=DiffSBDD/README.md): Structure-based Drug Design with Equivariant Diffusion Models

DiffSBDD is an equivariant diffusion model for structure-based drug design. In this repository, its architecture has been modified to be conditioned by ATOMICA embeddings.

**For full installation, training, and usage details, please see the [DiffSBDD README](https://www.google.com/search?q=DiffSBDD/README.md).**

### :scroll: Citation 
```
@article{schneuing2024diffsbdd,
   title={Structure-based drug design with equivariant diffusion models},
   author={Schneuing, Arne and Harris, Charles and Du, Yuanqi and Didi, Kieran and Jamasb, Arian and Igashov, Ilia and Du, Weitao and Gomes, Carla and Blundell, Tom L and Lio, Pietro and Welling, Max and Bronstein, Michael and Correia, Bruno},
   journal={Nature Computational Science},
   year={2024},
   month={Dec},
   day={01},
   volume={4},
   number={12},
   pages={899-909},
   issn={2662-8457},
   doi={10.1038/s43588-024-00737-x},
   url={[https://doi.org/10.1038/s43588-024-00737-x](https://doi.org/10.1038/s43588-024-00737-x)}
}
```
